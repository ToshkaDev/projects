general:
  branches:
    only:
      - f-circleci-testing

machine:
  services:
    - docker
  node:
    # Necessary for using the ES6 features of some of our scripts
    version: 6.4
  environment:
    NODE_ENV: develop
    MOCHA_REPORTER: mocha-circleci-reporter
    TZ: America/New_York

dependencies:
  cache_directories:
    - '~/cache'
    - node_modules
    - core-lib/node_modules
    - mist-lib/node_modules
    - mist-pipeline/node_modules
    - mist-pipeline/vendor

  override:
    # Small speed-up; https://twitter.com/gavinjoyce/status/691773956144119808
    - npm set progress=false && npm prune && npm install
    - mkdir -p ~/cache/built/$CIRCLE_BRANCH
    # All tests will be run on the docker image
    - bin/circleci/setup-test-docker-image.sh
    - bin/circleci/detect-projects-to-build.sh build-targets.txt $CIRCLE_BRANCH > projects-to-build.txt
    - bin/circleci/install-dependencies.sh $(cat projects-to-build.txt)
    - bin/circleci/run-tests.sh $(cat projects-to-build.txt)

test:
  override:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit
    - if [[ -s projects-to-build.txt ]]; then bin/merge-junit-reports.js $(awk '{print $1 "/test-results.xml" }' projects-to-build.txt) > $CIRCLE_TEST_REPORTS/junit/test-results.xml; fi
